<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>QR Check-in Realtime (Firebase)</title>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  height: 100vh;
  display: flex;
  flex-direction: column;
}
.header { text-align: center; padding: 10px; }
.qr-container {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}
#qrcode {
  padding: 15px;
  border: 3px solid #2196f3;
  border-radius: 10px;
  background: #fff;
}
.footer { text-align: center; padding-bottom: 15px; }
.status-normal { color: green; }
.status-late { color: orange; }
.status-closed { color: red; }
table { margin: auto; border-collapse: collapse; }
td, th { border: 1px solid #ccc; padding: 5px 10px; }
</style>
</head>

<body>

<div class="header">
  <h2>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ QR Code (Realtime)</h2>
  <button onclick="startClass()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <div id="status"></div>
</div>

<div class="qr-container">
  <div id="qrcode"></div>
</div>

<div class="footer">
  <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</h3>
  <input id="studentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
  <button onclick="checkIn()">‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>

  <hr>

  <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Realtime)</h3>
  <table>
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
      </tr>
    </thead>
    <tbody id="log"></tbody>
  </table>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* üî¥ ‡πÉ‡∏™‡πà Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "qr-checkin-f6467.firebaseapp.com",
  databaseURL: "https://qr-checkin-f6467-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "qr-checkin-f6467",
  storageBucket: "qr-checkin-f6467.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const attendanceRef = ref(db, "attendance");

/* ‡πÉ‡∏´‡πâ JS ‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ */
window.push = push;
window.onValue = onValue;
window.remove = remove;
window.attendanceRef = attendanceRef;
</script>

<script>
let startTime = null;

/* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö */
function startClass() {
  startTime = new Date();
  document.getElementById("status").innerHTML =
    "<b class='status-normal'>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß (0‚Äì5 ‡∏ô‡∏≤‡∏ó‡∏µ = ‡∏õ‡∏Å‡∏ï‡∏¥, 5‚Äì10 = ‡∏™‡∏≤‡∏¢)</b>";
  updateQR();
  remove(attendanceRef); // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πà‡∏≤
}

/* ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
function getStatus() {
  if (!startTime) return "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°";
  const diff = (new Date() - startTime) / 60000;
  if (diff <= 5) return "‡∏õ‡∏Å‡∏ï‡∏¥";
  if (diff <= 10) return "‡∏°‡∏≤‡∏™‡∏≤‡∏¢";
  return "‡∏õ‡∏¥‡∏î";
}

/* ‡∏™‡∏£‡πâ‡∏≤‡∏á QR */
function updateQR() {
  const status = getStatus();
  document.getElementById("qrcode").innerHTML = "";

  if (status === "‡∏õ‡∏¥‡∏î") {
    document.getElementById("status").innerHTML =
      "<b class='status-closed'>‡∏õ‡∏¥‡∏î‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</b>";
    return;
  }

  new QRCode(document.getElementById("qrcode"), {
    text: location.href,
    width: 220,
    height: 220
  });

  setTimeout(updateQR, 1000);
}

/* ‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠ */
function checkIn() {
  const name = document.getElementById("studentName").value.trim();
  if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");

  const status = getStatus();
  if (status === "‡∏õ‡∏¥‡∏î") return alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

  push(attendanceRef, {
    name: name,
    status: status,
    time: new Date().toLocaleTimeString()
  });

  document.getElementById("studentName").value = "";
}

/* Realtime ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• */
onValue(attendanceRef, (snapshot) => {
  const tbody = document.getElementById("log");
  tbody.innerHTML = "";

  snapshot.forEach(child => {
    const d = child.val();
    tbody.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.status}</td>
        <td>${d.time}</td>
      </tr>`;
  });
});
</script>

</body>
</html>
