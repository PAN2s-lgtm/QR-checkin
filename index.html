<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>QR Check-in</title>

<!-- ‚úÖ QRCode library -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
body { font-family: sans-serif; padding: 20px }
.green { color: green }
table { border-collapse: collapse }
td { border: 1px solid #ccc; padding: 6px }
</style>
</head>

<body>

<h2 id="title"></h2>

<button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
<div id="status"></div>

<div id="qrSection">
  <div id="qrcode"></div>
</div>

<div id="studentSection">
  <input id="studentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
  <button id="checkBtn">‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
</div>

<h3 id="count"></h3>
<table>
  <tbody id="log"></tbody>
</table>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* ‚úÖ Firebase CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyB3dg0wdJSu312bnjoRU11gjgkDBGOdzVE",
  authDomain: "qr-checkin-f6467.firebaseapp.com",
  databaseURL: "https://qr-checkin-f6467-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "qr-checkin-f6467",
  storageBucket: "qr-checkin-f6467.appspot.com",
  messagingSenderId: "507122002102",
  appId: "1:507122002102:web:468ea88c3f5d2d48ecde17"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* DOM */
const title = document.getElementById("title");
const startBtn = document.getElementById("startBtn");
const statusEl = document.getElementById("status");
const countEl = document.getElementById("count");
const qrcodeEl = document.getElementById("qrcode");
const logEl = document.getElementById("log");
const studentName = document.getElementById("studentName");
const checkBtn = document.getElementById("checkBtn");

/* Mode */
const isStudent = location.hash === "#student";

/* Firebase path */
const today = new Date().toISOString().slice(0,10);
const attendanceRef = ref(db, "attendance/" + today);

/* UI */
if (isStudent) {
  title.innerText = "üì± ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠";
  startBtn.style.display = "none";
  qrcodeEl.style.display = "none";
} else {
  title.innerText = "üë®‚Äçüè´ ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ñ‡∏£‡∏π";
  document.getElementById("studentSection").style.display = "none";
}

/* ‡∏Ñ‡∏£‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏° */
startBtn.onclick = () => {
  statusEl.innerHTML = "<b class='green'>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</b>";
  qrcodeEl.innerHTML = "";
  new QRCode(qrcodeEl, {
    text: location.origin + location.pathname + "#student",
    width: 200,
    height: 200
  });
};

/* ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠ */
checkBtn.onclick = () => {
  const name = studentName.value.trim();
  if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");

  push(attendanceRef, {
    name,
    time: new Date().toLocaleTimeString()
  });

  studentName.value = "";
  alert("‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
};

/* ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ù‡∏±‡πà‡∏á‡∏Ñ‡∏£‡∏π */
onValue(attendanceRef, snap => {
  logEl.innerHTML = "";
  let count = 0;
  snap.forEach(c => {
    const d = c.val();
    count++;
    logEl.innerHTML += `<tr><td>${d.name}</td><td>${d.time}</td></tr>`;
  });
  countEl.innerText = "üë• ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß: " + count + " ‡∏Ñ‡∏ô";
});
</script>

</body>
</html>
