<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>QR Check-in Realtime</title>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
/* ===== ‡∏ò‡∏á‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢ ===== */
body {
  font-family: Arial, sans-serif;
  margin: 0;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  background: linear-gradient(
    to bottom,
    #d50000 0%, #d50000 20%,
    #ffffff 20%, #ffffff 40%,
    #1a237e 40%, #1a237e 60%,
    #ffffff 60%, #ffffff 80%,
    #d50000 80%, #d50000 100%
  );
}

.header, .footer, .qr-container {
  background: rgba(255,255,255,0.95);
  margin: 10px;
  border-radius: 10px;
  padding: 10px;
}

.header { text-align: center; }
.qr-container {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
}

#qrcode {
  padding: 15px;
  border: 3px solid #1a237e;
  border-radius: 10px;
  background: #fff;
}

table { margin: auto; border-collapse: collapse; }
td, th { border: 1px solid #ccc; padding: 5px 10px; }

.green { color: green; }
.red { color: red; }
</style>
</head>

<body>

<div class="header">
  <h2 id="title">‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ QR Code</h2>
  <button id="startBtn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
  <button id="clearBtn">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <div id="status"></div>
  <div id="count"></div>
</div>

<div class="qr-container">
  <div id="qrcode"></div>
</div>

<!-- ===== ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏π) ===== -->
<div class="footer" id="studentSection">
  <h3>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</h3>
  <input id="studentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
  <button id="checkBtn">‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
</div>

<!-- ===== ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡∏Ñ‡∏£‡∏π‡πÄ‡∏´‡πá‡∏ô‡∏ï‡∏•‡∏≠‡∏î) ===== -->
<div class="footer">
  <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
  <table>
    <thead>
      <tr>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
      </tr>
    </thead>
    <tbody id="log"></tbody>
  </table>
</div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

/* üî¥ Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì */
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "qr-checkin-f6467.firebaseapp.com",
  databaseURL: "https://qr-checkin-f6467-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "qr-checkin-f6467",
  storageBucket: "qr-checkin-f6467.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô */
const today = new Date().toISOString().slice(0,10);
const attendanceRef = ref(db, "attendance/" + today);

/* ===== ‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏´‡∏°‡∏î ===== */
const isStudent = location.search.includes("student");

/* ===== UI ===== */
const studentSection = document.getElementById("studentSection");
const startBtn = document.getElementById("startBtn");
const clearBtn = document.getElementById("clearBtn");
const title = document.getElementById("title");

if (isStudent) {
  // ‡πÇ‡∏´‡∏°‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
  startBtn.style.display = "none";
  clearBtn.style.display = "none";
  title.innerText = "üì± ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
} else {
  // ‡πÇ‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏π
  studentSection.style.display = "none";
  title.innerText = "üë®‚Äçüè´ ‡∏Ñ‡∏£‡∏π : ‡πÅ‡∏™‡∏î‡∏á QR ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô";
}

/* ===== Logic ===== */
let startTime = null;

startBtn.onclick = () => {
  startTime = new Date();
  status.innerHTML = "<b class='green'>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</b>";
  createQR();
};

clearBtn.onclick = () => {
  if (confirm("‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
    remove(attendanceRef);
  }
};

checkBtn.onclick = () => {
  if (!isStudent) return;

  const name = studentName.value.trim();
  if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠");
  if (!startTime) return alert("‡∏£‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏≤‡∏ö");

  const diff = (new Date() - startTime) / 60000;
  const statusText = diff <= 5 ? "‡∏õ‡∏Å‡∏ï‡∏¥" : diff <= 10 ? "‡∏°‡∏≤‡∏™‡∏≤‡∏¢" : "‡∏õ‡∏¥‡∏î";
  if (statusText === "‡∏õ‡∏¥‡∏î") return alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠");

  push(attendanceRef, {
    name,
    status: statusText,
    time: new Date().toLocaleTimeString()
  });

  studentName.value = "";
  alert("‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
};

/* ===== Realtime ===== */
onValue(attendanceRef, snap => {
  log.innerHTML = "";
  let count = 0;

  snap.forEach(c => {
    const d = c.val();
    count++;
    log.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.status}</td>
        <td>${d.time}</td>
      </tr>`;
  });

  countEl.innerHTML = `üë• ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß: ${count} ‡∏Ñ‡∏ô`;
});

/* ===== QR ===== */
function createQR() {
  qrcode.innerHTML = "";
  new QRCode(qrcode, {
    text: location.origin + location.pathname + "?student",
    width: 220,
    height: 220
  });
}
</script>

</body>
</html>
